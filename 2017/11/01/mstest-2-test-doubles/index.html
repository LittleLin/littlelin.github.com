<!DOCTYPE HTML>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  <title>使用 MSTest 撰寫單元測試套路整理 (2) - 處理物件相依 | Linson&#39;s Note</title>

  
  <meta name="author" content="LittleLin">
  

  
  <meta name="description" content="技術,隨筆,雜記">
  

  
  
  <meta name="keywords" content="Unit Test,MSTest">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="使用 MSTest 撰寫單元測試套路整理 (2) - 處理物件相依">

  <meta property="og:site_name" content="Linson&#39;s Note">

  
  <meta property="og:image" content="/favicon.ico">
  

  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="Linson&#39;s Note" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
</head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">Linson&#39;s Note</a>
    </h1>
    <p class="site-description"></p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">首頁</a></li>
      
        <li><a href="/archives">文章歸檔</a></li>
      
        <li><a href="/about">關於我</a></li>
      
        <li><a href="/atom.xml">RSS 訂閱</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>使用 MSTest 撰寫單元測試套路整理 (2) - 處理物件相依</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2017/11/01/mstest-2-test-doubles/" rel="bookmark">
        <time class="entry-date published" datetime="2017-11-01T06:00:00.000Z">
          2017-11-01
        </time>
      </a>
    </span>
  </div>

  

  <div class="article-content">
    <div class="entry">
      
        <h2><span id="前言">前言</span></h2><p>本篇文章主要是針對測試替身 (Test Doubles) 測試方式的一些套路技巧說明。</p>
<a id="more"></a>

<h2><span id="目錄">目錄</span></h2><!-- toc -->

<ul>
<li><a href="#4-引入外部相依-dependency">4. 引入外部相依 (Dependency)</a></li>
<li><a href="#41-什麼是外部相依-dependency">4.1 什麼是外部相依 (Dependency)？</a><ul>
<li><a href="#production-code-v11">Production Code (v1.1)</a></li>
<li><a href="#test-code">Test Code</a></li>
</ul>
</li>
<li><a href="#42-相依物件回傳罐頭回應">4.2 相依物件回傳罐頭回應</a><ul>
<li><a href="#自己實作罐頭回應">自己實作罐頭回應</a></li>
<li><a href="#使用-nsubstituens-library-簡化工作">使用 NSubstitue(NS) library 簡化工作</a></li>
</ul>
</li>
<li><a href="#43-相依物件拋出例外">4.3 相依物件拋出例外</a><ul>
<li><a href="#production-code-v12">Production Code (v1.2)</a></li>
<li><a href="#test-code-1">Test Code</a></li>
</ul>
</li>
<li><a href="#5-測試物件間的互動">5. 測試物件間的互動</a><ul>
<li><a href="#production-code-v13">Production Code (v1.3)</a></li>
<li><a href="#test-code-2">Test Code</a></li>
</ul>
</li>
<li><a href="#小結">小結</a></li>
<li><a href="#references">References</a></li>
</ul>
<!-- tocstop -->

<h2><span id="4-引入外部相依-dependency">4. 引入外部相依 (Dependency)</span></h2><h2><span id="41-什麼是外部相依-dependency">4.1 什麼是外部相依 (Dependency)？</span></h2><p>現如今軟體系統越做越大，已經不可能由單一系統元件，就可以完成所有工作。</p>
<p>往大了看，一個系統背後可能會呼叫不同的 Web API 來協助完成工作，比方說一個登入頁面可能會呼叫 OAuth 的 web service 來進行使用者登入動作；往小處看，一個類別 (Class) 可能也會需要與其他類別協作，比方說在 .NET 傳統的<em>三層式架構 (Presentation Layer、Business Logic Layer、Data Access Layer)</em> 下，一個 BLL class 可能會使用不同的 DAO class 來進行資料存取的動作。</p>
<p>對我們來說，這些非我族類的系統或是類別，我們都可以視為是外部相依。</p>
<p>讓我們修改<a href="/2017/10/31/mstest-1-basic/#3-%E9%A9%97%E8%A8%BC%E6%B8%AC%E8%A9%A6%E7%89%A9%E4%BB%B6%E7%8B%80%E6%85%8B">上篇文章</a> 的例子，假設現在銀行要鼓勵存款，所以提出一個行銷活動︰每次存款都有 1% 的機率，可以即時獲得回饋金 10 元，架構大概像這樣︰</p>
<img src="/2017/11/01/mstest-2-test-doubles/arch.png" title="很醜我知道，將就看一下 XD">

<p>為了達成上述目錄，讓我們修改 Production Code 如下︰</p>
<h3><span id="production-code-v11">Production Code (v1.1)</span></h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 樂透機</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">ILotteryMachine</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 是否得獎</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>true 表示得獎<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">IsPrizeWinner</span>(<span class="params"></span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 樂透機</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">LotteryMachine</span> : <span class="title">ILotteryMachine</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 是否得獎</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>true 表示得獎<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">bool</span> <span class="title">IsPrizeWinner</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// 避免失焦，此處忽略實作，假設真實實作了 1% 中獎率</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 銀行帳戶</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BankAccount</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 樂透機</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> ILotteryMachine LotteryMachine;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 帳號餘額</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> Balance &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Bank Account 建構子</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="initialAmount"&gt;</span>帳戶初始餘額<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BankAccount</span>(<span class="params"><span class="keyword">int</span> initialAmount</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">this</span>.Balance = initialAmount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 存款</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="amount"&gt;</span>存入數量<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DepositMoney</span>(<span class="params"><span class="keyword">int</span> amount</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">this</span>.Balance += amount;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.LotteryMachine.IsPrizeWinner())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>.Balance += <span class="number">10</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>針對這樣的 Production Code，我們該如何測試呢？假設我們現在想測試「存款並中獎」的情境，直覺上，我們可能會將測試程式寫成以下格式︰</p>
<h3><span id="test-code">Test Code</span></h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">TestClass</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BankAccountTest</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">TestMethod</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> DepositMoney_存款<span class="number">100</span>元進餘額為<span class="number">33</span>元的帳戶中_活動中獎_帳戶餘額應為<span class="number">143</span>元()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Arrange</span></span><br><span class="line">        <span class="keyword">var</span> lotteryMachine = <span class="keyword">new</span> LotteryMachine();</span><br><span class="line">        <span class="keyword">var</span> target = <span class="keyword">new</span> BankAccount(<span class="number">33</span>);</span><br><span class="line">        target.LotteryMachine = lotteryMachine;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Act</span></span><br><span class="line">        target.DepositMoney(<span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Assert</span></span><br><span class="line">        <span class="keyword">var</span> expected = <span class="number">143</span>;</span><br><span class="line">        Assert.AreEqual(expected, target.Balance);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這樣的測試程式看起來是對的，也可以執行，但一旦您真的執行此測試程式，你會發現什麼呢？那就是如果您的 Production Code 沒有實作錯誤的話，您的 Test Case 是綠燈的可能性<strong>只有 1%</strong>！</p>
<p>為什麼呢？因為在您的 Test Code 中，<code>BankAccount</code> 類別是使用真實的 <code>LotteryMachine</code> 實作，而 <code>LotteryMachine</code> 在真實的情形下，真正中獎的機率就是 1%，也就造成這個「中獎」的測試案例會成真的機率只有 1% 了。</p>
<p>從這例子中，我們可以看到，待測物件 <code>BankAccount</code> 使用相依物件 <code>LotteryMachine</code>，會造成測試案例無法穩定執行。但回頭來看，其實我們想要驗証的邏輯，並不是「樂透機中獎了沒？」，而是「當樂透機顯示中獎的前提下，我的商業邏輯可不可以正常運作？」</p>
<p>從這角度出發，是不是我們可以提供待測物件 <code>BankAccount</code> 一個「穩定會中獎」的樂透機，讓我們可以驗証的商業邏輯呢？</p>
<p><a href="#目錄">回到目錄</a></p>
<h2><span id="42-相依物件回傳罐頭回應">4.2 相依物件回傳罐頭回應</span></h2><h3><span id="自己實作罐頭回應">自己實作罐頭回應</span></h3><p>當然熟悉 OOP 的同學會想，我可以自己去實作 <code>ILotteryMachine</code> 界面，讓 <code>IsPrizeWinner()</code> 方法總是回傳 <code>true</code>(中奬)，不就可以設定「總是中獎」這個情境了嗎？像這樣︰</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">AlwaysWinLotteryMachine</span> : <span class="title">ILotteryMachine</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">bool</span> <span class="title">IsPrizeWinner</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[<span class="meta">TestClass</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BankAccountTest</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">TestMethod</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> DepositMoney_存款<span class="number">100</span>元進餘額為<span class="number">33</span>元的帳戶中_活動中獎_帳戶餘額應為<span class="number">143</span>元()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Arrange</span></span><br><span class="line">        <span class="keyword">var</span> lotteryMachine = <span class="keyword">new</span> AlwaysWinLotteryMachine();</span><br><span class="line">        <span class="keyword">var</span> target = <span class="keyword">new</span> BankAccount(<span class="number">33</span>);</span><br><span class="line">        target.LotteryMachine = lotteryMachine;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Act</span></span><br><span class="line">        target.DepositMoney(<span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Assert</span></span><br><span class="line">        <span class="keyword">var</span> expected = <span class="number">143</span>;</span><br><span class="line">        Assert.AreEqual(expected, target.Balance);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我們實作一個新的 <code>AlwaysWinLotteryMachine</code> class，讓 <code>IsPrizeWinner()</code> 方法總是回傳 <code>true</code>，就可以設定中獎的情形了。當然這是一個好的思路，但這種純手工的做法有個明顯的缺點，就是會讓您的 Test Code 充斥非常多給測試用的人工類別，除了降低 Test Code 的可讀性之外，也會令 Test Code 越來越複雜。</p>
<p>舉例來說，如果我們又要驗証「沒中獎」這情形，按照上述做法，我們可能會再實作一個 <code>AlwaysLoseLotteryMachine</code> 類別，最終我們的 Test Code 就會變成這樣︰</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">AlwaysWinLotteryMachine</span> : <span class="title">ILotteryMachine</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">bool</span> <span class="title">IsPrizeWinner</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title">AlwaysLoseLotteryMachine</span> : <span class="title">ILotteryMachine</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">bool</span> <span class="title">IsPrizeWinner</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[<span class="meta">TestClass</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BankAccountTest</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">TestMethod</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> DepositMoney_存款<span class="number">100</span>元進餘額為<span class="number">33</span>元的帳戶中_活動中獎_帳戶餘額應為<span class="number">143</span>元()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Arrange</span></span><br><span class="line">        <span class="keyword">var</span> lotteryMachine = <span class="keyword">new</span> AlwaysWinLotteryMachine();</span><br><span class="line">        <span class="keyword">var</span> target = <span class="keyword">new</span> BankAccount(<span class="number">33</span>);</span><br><span class="line">        target.LotteryMachine = lotteryMachine;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 下略...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">TestMethod</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> DepositMoney_存款<span class="number">100</span>元進餘額為<span class="number">33</span>元的帳戶中_活動未中獎_帳戶餘額應為<span class="number">133</span>元()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Arrange</span></span><br><span class="line">        <span class="keyword">var</span> lotteryMachine = <span class="keyword">new</span> AlwaysLoseLotteryMachine();</span><br><span class="line">        <span class="keyword">var</span> target = <span class="keyword">new</span> BankAccount(<span class="number">33</span>);</span><br><span class="line">        target.LotteryMachine = lotteryMachine;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 下略...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>您看我們的 Test Code 是不是越來越肥大了呢？有沒有比較簡單又省事的做法可以使用呢？</p>
<h3><span id="使用-nsubstituens-library-簡化工作">使用 NSubstitue(NS) library 簡化工作</span></h3><p>因為上述的情形，在撰寫測試時非常常見，所以為了減少這段無用化，就會有許多人開發相關的 mocking library / framework。在我們家，我們目前使用的 mocking framework 則是 <a href="http://nsubstitute.github.io/" target="_blank" rel="noopener">NSubstitute</a>。</p>
<p>回到上述的問題，使用 <a href="http://nsubstitute.github.io/" target="_blank" rel="noopener">NSubstitute</a> 的話，我們的測試程式，就可以簡化為︰</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">TestClass</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BankAccountTest</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">TestMethod</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> DepositMoney_存款<span class="number">100</span>元進餘額為<span class="number">33</span>元的帳戶中_活動中獎_帳戶餘額應為<span class="number">143</span>元()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Arrange</span></span><br><span class="line">        <span class="keyword">var</span> lotteryMachine = NSubstitute.Substitute.For&lt;ILotteryMachine&gt;();</span><br><span class="line">        lotteryMachine.IsPrizeWinner().Returns(<span class="literal">true</span>); <span class="comment">// 中獎</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> target = <span class="keyword">new</span> BankAccount(<span class="number">33</span>);</span><br><span class="line">        target.LotteryMachine = lotteryMachine;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 下略...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">TestMethod</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> DepositMoney_存款<span class="number">100</span>元進餘額為<span class="number">33</span>元的帳戶中_活動未中獎_帳戶餘額應為<span class="number">133</span>元()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Arrange</span></span><br><span class="line">        <span class="keyword">var</span> lotteryMachine = NSubstitute.Substitute.For&lt;ILotteryMachine&gt;();</span><br><span class="line">        lotteryMachine.IsPrizeWinner().Returns(<span class="literal">false</span>); <span class="comment">// 沒中獎</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> target = <span class="keyword">new</span> BankAccount(<span class="number">33</span>);</span><br><span class="line">        target.LotteryMachine = lotteryMachine;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 下略...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>從上面的程式碼中，可以看到，我們使用了 <code>NSubstitute.Substitute.For&lt;ILotteryMachine&gt;()</code> 方法來幫我們建立一個 <code>ILotteryMachine</code> 的替身假物件，並且在 <code>lotteryMachine.IsPrizeWinner().Returns(true);</code> 這一行 statement 中，使用了 <code>Returns()</code> 來告訴我們的假物件，針對 <code>IsPrizeWinner()</code> 這方法一律只回傳 <code>true</code> 或 <code>false</code> 的罐頭回應。</p>
<p>您可以比較看看，我們使用 NS 改寫的 Test Code，與上一章節中，我們手工建立的 <code>AlwaysWinLotteryMachine</code>、<code>AlwaysLoseLotteryMachine</code> 類別相比，測試程式的可讀性與精簡度是不是大幅提升了呢？</p>
<p>其實這樣單純只是回傳罐頭回應的假物件，有個學名稱之為 <strong>Stub</strong>，細部的定義可以查看 <a href="#references">References</a> 中的文章，對這名詞會有更深入的了解。</p>
<p><a href="#目錄">回到目錄</a></p>
<h2><span id="43-相依物件拋出例外">4.3 相依物件拋出例外</span></h2><p>很多時候我們在撰寫程式時，不能假定世界一定都會運作如常。要記住只要是程式，就一定會有出錯的可能，能不能預先設想程式可能出錯的情形，並做好良好的錯誤處理，也是我們看待一位工程師能力成熟度的指標之一。</p>
<p>現在假定我們的樂透機可能會出錯並拋出例外，對於我們的 <code>BankAccount</code> 類別來說，為了不影響使用者的操作體驗，可能會需要將 <code>LotteryMachine</code> 拋出的例外給 catch 住，並記錄相關 log。這種時候雖然對不起存戶，但可能就視本次存款沒有中獎，不提供給存戶獎金。</p>
<p>我們可能會將 Production Code 改寫為這樣︰</p>
<h3><span id="production-code-v12">Production Code (v1.2)</span></h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 銀行帳戶</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BankAccount</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 略...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 存款</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="amount"&gt;</span>存入數量<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DepositMoney</span>(<span class="params"><span class="keyword">int</span> amount</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">this</span>.Balance += amount;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">bool</span> isPrizeWinner = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            isPrizeWinner = <span class="keyword">this</span>.LotteryMachine.IsPrizeWinner();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 相關錯誤處理，此處略...</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isPrizeWinner)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>.Balance += <span class="number">10</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這時候我們要怎麼驗証這個「因為樂透機出錯所以視為不中獎沒有獎金」(好繞，但您懂的)的商業邏輯呢？聰明的您一定想到了，可以利用上面我們提到的 <strong>Stub</strong> 物件了，是不是可以讓我們的罐頭物件穩定的拋出例外呢？</p>
<p>有的，大部份的 mocking library / framework 都可以做到這件事，下面我們一樣以 <a href="http://nsubstitute.github.io/" target="_blank" rel="noopener">NSubstitute</a> 來做示範︰</p>
<h3><span id="test-code">Test Code</span></h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">TestClass</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BankAccountTest</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 略...    </span></span><br><span class="line"></span><br><span class="line">    [<span class="meta">TestMethod</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> DepositMoney_存款<span class="number">100</span>元進餘額為<span class="number">33</span>元的帳戶中_樂透機出錯視為未中獎_帳戶餘額應為<span class="number">133</span>元()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Arrange</span></span><br><span class="line">        <span class="keyword">var</span> lotteryMachine = NSubstitute.Substitute.For&lt;ILotteryMachine&gt;();</span><br><span class="line">        lotteryMachine.IsPrizeWinner().Returns(x =&gt; &#123; <span class="keyword">throw</span> <span class="keyword">new</span> Exception(); &#125;); <span class="comment">// 出錯</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> target = <span class="keyword">new</span> BankAccount(<span class="number">33</span>);</span><br><span class="line">        target.LotteryMachine = lotteryMachine;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Act</span></span><br><span class="line">        target.DepositMoney(<span class="number">100</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Assert</span></span><br><span class="line">        <span class="keyword">var</span> expected = <span class="number">133</span>;</span><br><span class="line">        Assert.AreEqual(expected, target.Balance);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 略...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到我們將 <code>Returns()</code> 方法回傳的罐頭回應改為拋出例外，並驗証我們的 <code>BankAccount</code> 目標類別，可不可以正確處理這樣子的錯誤情形。</p>
<p><a href="#目錄">回到目錄</a></p>
<h2><span id="5-測試物件間的互動">5. 測試物件間的互動</span></h2><p>讓我們再回到上述樂透機出錯的情形，現在假設我們想要在樂透機出錯時，在 Log 下記錄相關訊息。比方說我想記錄存戶當時正在存多少錢，我們可能會將 Production Code 再改為以下︰</p>
<h3><span id="production-code-v13">Production Code (v1.3)</span></h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Logger</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">ILogger</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 記錄 Log 資訊</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="logMessage"&gt;</span>Log 資訊<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Log</span>(<span class="params"><span class="keyword">string</span> logMessage</span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 將 Log 寫至檔案中</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">FileLogger</span> : <span class="title">ILogger</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 記錄 Log 資訊</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="logMessage"&gt;</span>Log 資訊<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Log</span>(<span class="params"><span class="keyword">string</span> logMessage</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// 忽略細節</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 銀行帳戶</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BankAccount</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 樂透機</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> ILotteryMachine LotteryMachine;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 帳號餘額</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> Balance &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Logger </span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> ILogger Logger &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Bank Account 建構子</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="initialAmount"&gt;</span>帳戶初始餘額<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BankAccount</span>(<span class="params"><span class="keyword">int</span> initialAmount</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">this</span>.Balance = initialAmount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 存款</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="amount"&gt;</span>存入數量<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DepositMoney</span>(<span class="params"><span class="keyword">int</span> amount</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">this</span>.Balance += amount;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">bool</span> isPrizeWinner = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            isPrizeWinner = <span class="keyword">this</span>.LotteryMachine.IsPrizeWinner();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>.Logger.Log(<span class="string">$"存戶存款 <span class="subst">&#123;amount&#125;</span> 時，樂透機出錯！"</span>);</span><br><span class="line">            <span class="comment">// 相關錯誤處理，此處略...</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isPrizeWinner)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>.Balance += <span class="number">10</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>針對這樣子的程式碼，我們又該如何測試呢？此時我們驗証的重點，已經不是 <code>BankAccount</code> 物件的餘額是否正確，而是「<code>BankAccount</code> 物件在 <code>LotteryMachine</code> 出錯的前提下，有沒有正確呼叫 <code>Logger</code> 並寫入正確的 Log 了」(我知道，唸起來一樣很繞)</p>
<p>針對驗証 <code>BankAccount</code> 物件與 <code>Logger</code> 物件間的<strong>互動行為</strong> (在此例中，就是 <code>BankAccount</code> 有沒有呼叫 <code>Logger</code> &amp; 訊息是否如預期) 是否正確的測試方式，我們稱之為 <code>Behavior-based Verification</code> (行為驗証)，針對這樣的驗証需要，我們該如何撰寫 Test Code 呢？</p>
<p>此時又要再向大家介紹另一種假物件的形式︰<strong>Mock</strong>，讓我們先看看 Test Code 該如何寫︰</p>
<h3><span id="test-code">Test Code</span></h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">TestClass</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BankAccountTest</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 略...</span></span><br><span class="line">    </span><br><span class="line">    [<span class="meta">TestMethod</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> DepositMoney_存款<span class="number">100</span>元時_樂透機出錯_應正確寫入Log()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Arrange</span></span><br><span class="line">        <span class="keyword">var</span> lotteryMachine = NSubstitute.Substitute.For&lt;ILotteryMachine&gt;();</span><br><span class="line">        lotteryMachine.IsPrizeWinner().Returns(x =&gt; &#123; <span class="keyword">throw</span> <span class="keyword">new</span> Exception(); &#125;); <span class="comment">// 出錯</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> logger = NSubstitute.Substitute.For&lt;ILogger&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> target = <span class="keyword">new</span> BankAccount(<span class="number">33</span>);</span><br><span class="line">        target.LotteryMachine = lotteryMachine;</span><br><span class="line">        target.Logger = logger;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Act</span></span><br><span class="line">        target.DepositMoney(<span class="number">100</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Assert</span></span><br><span class="line">        logger.Received().Log(<span class="string">"存戶存款 100 時，樂透機出錯！"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 略...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面 Test Code 中的 <code>logger</code> 就是我們所說的 <strong>Mock</strong> object，可以看到 我們一樣是使用 <code>NSubstitute.Substitute.For&lt;&gt;()</code> 方法來建立這個 <strong>Mock</strong> object，但在測試的用途上，我們就不是使用 <code>Returns()</code> 方法來讓 <code>logger</code> 來回傳罐頭訊息，而是使用 <code>Received()</code> 來驗証，<code>logger</code> 是否有如我們預期被 <code>BankAccount</code> 物件所呼叫。</p>
<p>針對這方面的 API 細節資訊，可以再閱讀 NS 官網上 <a href="http://nsubstitute.github.io/help/received-calls/" target="_blank" rel="noopener">Checking received calls</a> 文件，會有更多細節的了解。</p>
<h2><span id="小結">小結</span></h2><p>本文說明了在程式中引入相依性時，該如何進行測試的思路與手法。說穿了就是 2 種測試物件︰<strong>Stub</strong> 與 <strong>Mock</strong>，在實務上我們常會視需求穿插使用這 2 種測試物件，因此了解它們的特性與差異是非常有必要的。針對它們的定義想有更清楚的了解，可以閱讀 <a href="#references">References</a> 中的參考文件，會大有幫助。</p>
<p>在下一篇文章中，我會再補充，一般 .NET 程式使用 MSTest 撰寫測試時，還有哪些實用的技巧與注意事項，我們下次見。</p>
<h2><span id="references">References</span></h2><ul>
<li>[[[30 天快速上手 TDD][Day 7]Unit Test - Stub, Mock, Fake 簡介]](<a href="https://dotblogs.com.tw/hatelove/2012/11/29/learning-tdd-in-30-days-day7-unit-testing-stub-mock-and-fake-object-introduction" target="_blank" rel="noopener">https://dotblogs.com.tw/hatelove/2012/11/29/learning-tdd-in-30-days-day7-unit-testing-stub-mock-and-fake-object-introduction</a>)</li>
<li><a href="https://martinfowler.com/articles/mocksArentStubs.html" target="_blank" rel="noopener">Mocks Aren’t Stubs</a></li>
<li><a href="https://blog.pragmatists.com/test-doubles-fakes-mocks-and-stubs-1a7491dfa3da" target="_blank" rel="noopener">Test Doubles — Fakes, Mocks and Stubs.</a></li>
<li><a href="https://www.industriallogic.com/blog/mock-objects-pictures/" target="_blank" rel="noopener">Fake and Mock Objects in Pictures</a></li>
<li><a href="http://nsubstitute.github.io/" target="_blank" rel="noopener">NSubstitute 官網</a></li>
</ul>
<p><a href="#目錄">回到目錄</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/Unit-Test/">Unit Test</a><a href="/tags/MSTest/">MSTest</a>
    </span>
    

    </div>

    
  </div>
</article>

  
	<section id="comments" class="comment">
	  <div id="disqus_thread">
	  <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
	  </div>
	</section>

	<script type="text/javascript">
	var disqus_shortname = 'littlelin';
	(function(){
	  var dsq = document.createElement('script');
	  dsq.type = 'text/javascript';
	  dsq.async = true;
	  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
	  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	}());
	(function(){
	  var dsq = document.createElement('script');
	  dsq.type = 'text/javascript';
	  dsq.async = true;
	  dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
	  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	}());
	</script>





    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2019 LittleLin
    
  </p>
</footer>
    
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-160596-11', 'auto');
    ga('send', 'pageview');

</script>

  </div>
</div>
</body>
</html>